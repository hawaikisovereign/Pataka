name: Update CHANGELOG with LLM Agent

on:
  push:
    branches: [main]

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get git log diff
        id: git_diff
        run: |
          echo "## Commit Diff:" > changes.txt
          git log -1 --pretty=format:"%s%n%n%b" >> changes.txt
          echo "Generated git diff:"
          cat changes.txt

      - name: Generate changelog update
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -sS \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4o",
              "messages": [
                {
                  "role": "system",
                  "content": "You are an expert release note writer for a kaupapa Māori AI project. Read the provided commit message and summarize it into a clear, friendly changelog update suitable for Māori and Indigenous developers."
                },
                {
                  "role": "user",
                  "content": "'"$(cat changes.txt | sed 's/"/\\"/g')"'"
                }
              ],
              "max_tokens": 300,
              "temperature": 0.7
            }')

          echo "$RESPONSE" | jq -r '.choices[0].message.content' > changelog_update.txt

          echo "Generated changelog entry:"
          cat changelog_update.txt

      - name: Update CHANGELOG.md
        run: |
          echo "" >> CHANGELOG.md
          echo "### $(date '+%Y-%m-%d')" >> CHANGELOG.md
          cat changelog_update.txt >> CHANGELOG.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update changelog with AI agent"
          title: "chore: update changelog with AI agent"
          body: |
            This PR was created automatically by the changelog AI agent.
          branch: changelog-ai-update
